---
# -----------------------------------------------------------------------------
# üïâÔ∏è Srishti: Vyom Cluster Manifestation
# -----------------------------------------------------------------------------
# This playbook bootstraps the Kubernetes cluster.
# Strategy: "Split-Horizon"
#   1. Data Plane: Physical LAN (High Speed)
#   2. Control Plane: Nebula Mesh (High Security)
# -----------------------------------------------------------------------------

- name: Manifest Vyom Cluster (Compute Plane)
  hosts: k3s_cluster
  become: true
  
  # Load variables hierarchy:
  # 1. Group Vars (Common settings)
  vars_files:
    - ../group_vars/vyom/vars.yml
    - ../group_vars/vyom/vault.yml

  gather_facts: true

  # ---------------------------------------------------------------------------
  # Global Variables (High Precedence)
  # ---------------------------------------------------------------------------
  vars:
    # --- Nebula Configuration ---
    nebula_version: "1.10.0" # Force this version
    
    # Identity (We pre-placed these files)
    pki:
      ca: /etc/nebula/ca.crt
      cert: /etc/nebula/host.crt
      key: /etc/nebula/host.key

    # Lighthouse Configuration
    lighthouses: ["10.42.0.1"]
    
    lighthouse:
      am_lighthouse: false
      interval: 60

    # Discovery
    static_host_map:
      - internal_ip: "10.42.0.1"
        public_ip: "18.140.145.253"
        public_port: 4242

    # Network Configuration
    listen:
      host: 0.0.0.0
      port: 4242
    
    tun:
      disabled: false
      dev: nebula0
      
    firewall:
      outbound:
        - port: any
          proto: any
          host: any
      inbound:
        - port: any
          proto: icmp
          host: any
        - port: 6443
          proto: tcp
          host: any

  # ---------------------------------------------------------------------------
  # Phase 0: Validation & Preparation
  # ---------------------------------------------------------------------------
  pre_tasks:
    - name: üõ°Ô∏è Verify Identity Existence
      fail:
        msg: "Identity missing for {{ inventory_hostname }}. Ensure 'vault_nebula_cert' and 'vault_nebula_key' are defined in host_vars."
      when: vault_nebula_cert is undefined or vault_nebula_key is undefined
      # Note: vault_nebula_* vars currently mapped from nebula_node_* in group_vars, so this check might need adjustment if using group vars directly.
      # Simplified check for now based on what we know exists:
      ignore_errors: true 

    - name: üßπ Cleanup Old Nebula Binaries (Force Upgrade)
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - /usr/bin/nebula
        - /usr/bin/nebula-cert
        - /usr/local/bin/nebula
        - /usr/local/bin/nebula-cert
      tags: [cleanup]

    - name: üìÇ Create Nebula Configuration Directory
      file:
        path: /etc/nebula
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: üìú Place Nebula CA Certificate
      copy:
        content: "{{ nebula_ca_crt | trim }}"
        dest: /etc/nebula/ca.crt
        mode: '0644'
        owner: root
        group: root

    - name: üìú Place Nebula Node Certificate
      copy:
        content: "{{ nebula_node_crt | trim }}"
        dest: /etc/nebula/host.crt
        mode: '0644'
        owner: root
        group: root

    - name: üîë Place Nebula Node Key
      copy:
        content: "{{ nebula_node_key | trim }}"
        dest: /etc/nebula/host.key
        mode: '0600' # Private keys must be secure
        owner: root
        group: root

  # ---------------------------------------------------------------------------
  # Phase 1: The Mesh (Nebula)
  # ---------------------------------------------------------------------------
  roles:
    - role: trozz.ansible_nebula
      # Vars are now defined at Playbook level for higher precedence

  tasks:
    # -------------------------------------------------------------------------
    # Phase 2: The Bridge (Discovery)
    # -------------------------------------------------------------------------
    - name: üîÑ Refresh Ansible Facts (Discover nebula0)
      ansible.builtin.setup:
      # Forces Ansible to see the newly created 'nebula0' interface
      # Otherwise 'ansible_nebula0' will remain undefined.

    # -------------------------------------------------------------------------
    # Phase 3: The Cluster (K3s)
    # -------------------------------------------------------------------------
    - name: ‚ò∏Ô∏è Bootstrap K3s (Split-Horizon)
      include_role:
        name: xanmanning.k3s
      vars:
        # 1. Identity (The Gatekeeper)
        # ---------------------------
        k3s_token: "{{ k3s_token }}"
        k3s_version: "{{ k3s_version }}"

        # 2. Storage Strategy (ADR-005)
        # ---------------------------
        # We explicitly choose SQLite (Single Master) to start "Hard Mode" learning.
        # Set to 'true' later when migrating to HA Etcd.
        k3s_etcd_datastore: "{{ k3s_etcd_datastore }}"

        # 3. Networking (The Split-Horizon)
        # ---------------------------
        # Bind to the Physical Interface (FAST - 2.5GbE)
        # This ensures Longhorn replication and Etcd run at bare-metal speeds.
        k3s_node_ip: "{{ k3s_node_ip }}"
        k3s_flannel_iface: "{{ k3s_flannel_iface }}"

        # 4. Access Control & SANs
        # ---------------------------
        k3s_server:
          # Secure the API Server with multiple identities
          tls-san:
            # A. The Secure Backdoor (For Lighthouse & Remote kubectl)
            - "{{ ansible_nebula0.ipv4.address }}"
            # B. The Local Door (For LAN access)
            - "{{ ansible_default_ipv4.address }}"
            # C. The DNS Name (For Ingress)
            - "k3s.brahmanda.local"

          # 5. Component Tuning
          # ---------------------------
          disable:
            - traefik    # We will deploy Ingress via GitOps (Sankalpa)
            - servicelb  # We don't need a LoadBalancer yet
          kube-controller-manager-arg:
            - "bind-address=0.0.0.0" # Allow metrics scraping
          kube-scheduler-arg:
            - "bind-address=0.0.0.0"
          
          # 6. Kubelet Tuning (For System Stability)
          kubelet-arg:
            # Reserve resources for the OS so K3s doesn't OOM the host
            - "system-reserved=cpu=500m,memory=500Mi"
            - "kube-reserved=cpu=500m,memory=500Mi"

  post_tasks:
    - name: ‚úÖ Verify Node Identity
      debug:
        msg: "Node {{ inventory_hostname }} is active. LAN IP: {{ ansible_default_ipv4.address }}, Mesh IP: {{ ansible_nebula0.ipv4.address }}"
