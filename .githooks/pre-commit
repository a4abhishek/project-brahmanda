#!/usr/bin/env bash
#
# Git Pre-Commit Hook: Bootstrap Security Guardrail
#
# Purpose: Prevent accidental commit of modified answer.toml with real passwords
# Philosophy: "Weapon of Detachment" - secrets must never enter version control
#
# This hook checks if answer.toml has been modified from its template state.
# answer.toml.local (your actual config) is gitignored and safe.

set -e

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Path to answer.toml
ANSWER_FILE="samsara/proxmox/answer.toml"

# Check if answer.toml is staged for commit
if git diff --cached --name-only | grep -q "^${ANSWER_FILE}$"; then
    echo -e "${YELLOW}⚠️  Checking ${ANSWER_FILE} for secrets...${NC}"
    
    # Get staged content
    STAGED_CONTENT=$(git diff --cached --no-ext-diff "${ANSWER_FILE}")
    
    # Check if root_password has been changed from template
    if echo "$STAGED_CONTENT" | grep -q 'root_password = "CHANGE_THIS_TEMPORARY_PASSWORD"'; then
        echo -e "${GREEN}✅ ${ANSWER_FILE} appears to be template (no real password)${NC}"
    else
        echo -e "${RED}❌ COMMIT BLOCKED: ${ANSWER_FILE} contains a modified password!${NC}"
        echo ""
        echo -e "${YELLOW}Security Violation:${NC}"
        echo "  You are attempting to commit answer.toml with a real password."
        echo ""
        echo -e "${YELLOW}What you should do:${NC}"
        echo "  1. Your real configuration belongs in: ${ANSWER_FILE}.local (gitignored)"
        echo "  2. Template file (${ANSWER_FILE}) must keep placeholder password"
        echo "  3. To bypass this check (NOT recommended):"
        echo "     git commit --no-verify"
        echo ""
        echo -e "${YELLOW}Current Staged Changes:${NC}"
        git diff --cached "${ANSWER_FILE}" | grep -A 2 -B 2 "root_password"
        echo ""
        exit 1
    fi
    
    # Check if ssh_public_keys has been uncommented/added
    if echo "$STAGED_CONTENT" | grep -qE '^\+[^#]*ssh_public_keys\s*='; then
        echo -e "${RED}❌ COMMIT BLOCKED: ${ANSWER_FILE} contains SSH public keys!${NC}"
        echo ""
        echo -e "${YELLOW}Security Violation:${NC}"
        echo "  You are attempting to commit answer.toml with real SSH keys."
        echo ""
        echo -e "${YELLOW}What you should do:${NC}"
        echo "  1. SSH keys belong in: ${ANSWER_FILE}.local (gitignored)"
        echo "  2. Template file (${ANSWER_FILE}) must keep keys commented out"
        echo ""
        exit 1
    fi
fi

echo -e "${GREEN}✅ Pre-commit check passed${NC}"
exit 0
